<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>WebSocket RPC Demo</title>
</head>
<body>
<script type="module">
import { api } from "./api.d.ts"; // the auto-generated TS types

const ws = new WebSocket("ws://localhost:8080/ws");
const callbacks = {};
let counter = 0;

ws.onmessage = (event) => {
  const msg = JSON.parse(event.data);
  const cb = callbacks[msg.id];
  if (cb) {
    cb(msg.error, msg.result);
    delete callbacks[msg.id];
  }
};

const rpc = new Proxy(api, {
  get(_, funcName) {
    return (...args) => new Promise((resolve, reject) => {
      const id = (++counter).toString();
      callbacks[id] = (err, res) => err ? reject(err) : resolve(res);
      ws.send(JSON.stringify({ id, method: funcName, params: args }));
    });
  }
});

ws.onopen = async () => {
  const sum = await rpc.Add(2, 3);
  console.log("Sum:", sum); // 5

  const greeting = await rpc.Welcome({ Name: "Alice", Age: 30 });
  console.log(greeting); // "Hello Alice, you are 30 years old!"
};
</script>
</body>
</html>
